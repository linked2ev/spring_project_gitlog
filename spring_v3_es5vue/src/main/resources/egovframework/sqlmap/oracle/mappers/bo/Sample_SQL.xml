<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="Sample">
     
     
    <sql id="getSampleListWhere">
    	<if test="searchTeamGbn != null and searchTeamGbn != ''">
			AND B.TEAM_GBN = #{searchTeamGbn}
    	</if>
    	<if test="searchExamWay != null and searchExamWay != ''">
			AND B.EXAM_WAY_CD = #{searchExamWay}    		
    	</if>
    	<if test="searchVisitArea != null and searchVisitArea != ''">
    		<if test="searchExamWay == '01'">
    			AND B.VISIT_AREA_CD = #{searchVisitArea}
    		</if>
    	</if>
		<if test="searchExamTitle != null and searchExamTitle != ''">
			AND B.EXAM_TITLE LIKE '%' || #{searchExamTitle} || '%'    		
    	</if>
    </sql>
    
    
    <!-- 시험모집공고 목록 갯수 -->
    <select id="getSampleListCnt" parameterType="HashMap" resultType="Integer">
        SELECT
				COUNT(B.EXAM_MNG_NO)
		FROM 
				RDEI102DT A 
				INNER JOIN RDEI101MT B ON A.EXAM_MNG_NO = B.EXAM_MNG_NO
        WHERE 
        		A.USER_ID = #{USER_ID}
        		<include refid="getSampleListWhere"/>
    </select>
    
    
    <!-- 시험모집공고 목록 -->
    <select id="getSampleList" parameterType="HashMap" resultType="HashMap">
        SELECT
        		S2.*
     	FROM
     			(
		        SELECT
		        		ROWNUM AS RNUM
		                ,S1.* 
		        FROM
				        (
				        SELECT
								B.EXAM_MNG_NO /* 시험관리번호 */
						        ,B.TEAM_GBN /* 시험구분 */
						        ,B.EXAM_TITLE /* 시험제목 */
						        ,TO_CHAR(TO_DATE(B.APP_PERIOD_FROM, 'YYYYMMDD'), 'YYYY-MM-DD') || ' ~ ' || TO_CHAR(TO_DATE(B.APP_PERIOD_TO, 'YYYYMMDD'), 'YYYY-MM-DD') AS APP_PERIOD /* 신청기간 */
						        ,TO_CHAR(TO_DATE(B.EXAM_PERIOD_FROM, 'YYYYMMDD'), 'YYYY-MM-DD') || ' ~ ' || TO_CHAR(TO_DATE(B.EXAM_PERIOD_TO, 'YYYYMMDD'), 'YYYY-MM-DD') AS EXAM_PERIOD /* 시험기간 */
						        ,B.EXAM_WAY_CD /* 시험방식코드 */
						        ,CASE 
						        		B.EXAM_WAY_CD WHEN '01' THEN
							            CASE 
							            		B.VISIT_AREA_CD WHEN '01' THEN '방문(서울)'
							            		ELSE '방문(용인)' 
					            		END
							       		ELSE '온라인'
							    END AS EXAM_WAY /* 시험방식 */
							    ,CASE 
							    		WHEN B.RECRUIT_WAY_CD = '01' THEN '선착순'
							            ELSE '신청기간종료시까지'
							    END AS RECRUIT_WAY
						        ,CASE 
						        		WHEN A.PANEL_SEL_YN = 'Y' THEN 'selection' /* 패널선정 */
						            	WHEN A.EXAM_APP_YN = 'Y' THEN 'applying' /* 신청중 */ 
						            	ELSE 'available' /* 신청가능 */
						        END AS STATUS /* 상태 */
						FROM 
						 		RDEI102DT A 
						 		INNER JOIN RDEI101MT B ON A.EXAM_MNG_NO = B.EXAM_MNG_NO
				        WHERE 
				        		A.USER_ID = #{USER_ID}
							    <include refid="getSampleListWhere"/>
						ORDER BY
						 		B.APP_PERIOD_TO ASC
			 			)
			 			S1
				)
				S2
		WHERE
            	S2.RNUM BETWEEN #{firstRecordIdx} AND #{lastRecordIdx}
    </select>
    
    
    <!-- 시험모집 상세정보 --> 
   	<resultMap id="getSampleViewMap" type="HashMap">
			<result property="EXAM_MNG_NO" column="EXAM_MNG_NO" />
			<result property="EXAM_TITLE" column="EXAM_TITLE" />
			<result property="STATUS" column="STATUS" />
			<result property="MNG_CD" column="MNG_CD" />
			<result property="TEAM_GBN" column="TEAM_GBN" />
			<result property="DUP_APP" column="DUP_APP" />
			<result property="EXAM_APP_YN" column="EXAM_APP_YN" />
			<result property="EXAM_APP_YN2" column="EXAM_APP_YN2" />
			<result property="EXAM_WAY_CD" column="EXAM_WAY_CD" />
			<result property="VISIT_PLACE" column="VISIT_PLACE" />
			<result property="EXAM_WAY" column="EXAM_WAY" />
			<result property="RECRUIT_WAY" column="RECRUIT_WAY" />
			<result property="APP_PERIOD" column="APP_PERIOD" />
			<result property="EXAM_PERIOD" column="EXAM_PERIOD" />
			<result property="EXAM_OUTLINE" column="EXAM_OUTLINE" jdbcType="CLOB" javaType="java.lang.String" />
			<result property="APP_CANCEL_YN" column="APP_CANCEL_YN" />
	</resultMap>
    <select id="getSampleView" parameterType="HashMap" resultMap="getSampleViewMap">
		SELECT
				A.EXAM_MNG_NO
		        ,A.EXAM_TITLE
		        ,CASE 
		        		WHEN B.PANEL_SEL_YN = 'Y' THEN 'selection' /* 패널선정 */
		            	WHEN B.EXAM_APP_YN = 'Y' THEN 'applying' /* 신청중 */ 
		            	ELSE 'available' /* 신청가능 */
		        END AS STATUS /* 상태 */
		        ,A.MNG_CD
		        ,A.TEAM_GBN
		        ,CASE A.DUP_APP_CD 
		        		WHEN '01' THEN '불가'
		                WHEN '02' THEN '가능'
		        END AS DUP_APP
                ,CASE B.EXAM_APP_YN WHEN 'Y' THEN 'Y'
		            	ELSE 'N'
		        END AS EXAM_APP_YN
		        ,CASE A.STATE_CD WHEN '02' THEN 'Y' ELSE 'N' END AS EXAM_APP_YN2
		        ,A.EXAM_WAY_CD
		        ,A.VISIT_PLACE
       			,CASE A.EXAM_WAY_CD
       					WHEN '01' THEN
					            CASE A.VISIT_AREA_CD 
					            		WHEN '01' THEN '방문(서울)'
					            		ELSE '방문(용인)' 
			            		END
			       		ELSE '온라인'
			    END AS EXAM_WAY /* 시험방식 */
			    ,CASE 
			    		WHEN A.RECRUIT_WAY_CD = '01' THEN '선착순'
			            ELSE '신청기간종료시까지'
			    END AS RECRUIT_WAY
		        ,TO_CHAR(TO_DATE(A.APP_PERIOD_FROM || A.APP_START_TIME || '00', 'YYYYMMDD HH24MISS'), 'YYYY-MM-DD HH24:MI') || ' ~ ' || TO_CHAR(TO_DATE(A.APP_PERIOD_TO || A.APP_END_TIME || '00', 'YYYYMMDD HH24MISS'), 'YYYY-MM-DD HH24:MI') AS APP_PERIOD /* 신청기간 */
		        ,TO_CHAR(TO_DATE(A.EXAM_PERIOD_FROM, 'YYYYMMDD'), 'YYYY-MM-DD') || ' ~ ' || TO_CHAR(TO_DATE(A.EXAM_PERIOD_TO, 'YYYYMMDD'), 'YYYY-MM-DD') AS EXAM_PERIOD /* 시험기간 */
		        ,A.EXAM_OUTLINE
      			,CASE B.EXAM_APP_YN WHEN 'Y' THEN
      			     CASE 
                    	 WHEN SYSDATE - TO_DATE(A.APP_PERIOD_TO || A.APP_END_TIME || '00', 'YYYYMMDD HH24MISS') <![CDATA[<]]> 0 AND SYSDATE - TO_DATE(A.EXAM_PERIOD_TO, 'YYYYMMDD') <![CDATA[<]]> 0  THEN 'Y'
                    	 ELSE 'N'
                     END
                     ELSE 'N' 
                END AS APP_CANCEL_YN
		FROM 
				RDEI101MT A
				INNER JOIN RDEI102DT B ON A.EXAM_MNG_NO = B.EXAM_MNG_NO
		WHERE 	
				B.USER_ID = #{USER_ID}
				AND A.EXAM_MNG_NO = #{EXAM_MNG_NO}
    </select>
    
    
</mapper>
