<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="TestAnnounce">
	
	
	<sql id="testAnnounceWhere">
			<isNotEmpty property="searchTeamGbn" prepend="AND">
					B.TEAM_GBN = #searchTeamGbn#
			</isNotEmpty>
			<isNotEmpty property="searchExamWay" prepend="AND">
						B.EXAM_WAY_CD = #searchExamWay#
			</isNotEmpty>
			<isNotEmpty property="searchVisitArea" prepend="AND">
					<isEqual property="searchExamWay" compareValue="01">
							B.VISIT_AREA_CD = #searchVisitArea#
					</isEqual>
			</isNotEmpty>
			<isNotEmpty property="searchExamTitle" prepend="AND">
					B.EXAM_TITLE LIKE '%' || #searchExamTitle# || '%'
		    </isNotEmpty>
    </sql>
    
    
	<!-- 시험모집공고 목록 갯수 -->
    <select id="selectTestAnnounceListCnt" parameterClass="HashMap" resultClass="Integer">
        /* TestAnnounce.selectTestAnnounceListCnt */
        SELECT
				COUNT(B.EXAM_MNG_NO)
		FROM 
				RDEI102DT A 
				INNER JOIN RDEI101MT B ON A.EXAM_MNG_NO = B.EXAM_MNG_NO
        WHERE 
         		A.USER_ID = #USER_ID# /* 패널ID */
  	 			AND A.MSG_TRAN_YN = 'Y' /* 공고전송 */
   				AND B.EXAM_PERIOD_TO >= TO_CHAR(SYSDATE, 'YYYYMMDD') /* 시험일자 종료시까지 */
				<include refid="testAnnounceWhere"/>
    </select>
    
    
	<!-- 시험모집공고 목록 -->
    <select id="selectTestAnnounceList" parameterClass="HashMap" resultClass="HashMap">
        /* TestAnnounce.selectTestAnnounceList */
        SELECT
        		S2.*
     	FROM
     			(
		        SELECT
		        		ROWNUM AS RNUM
		                ,S1.* 
		        FROM
				        (
				        SELECT
								B.EXAM_MNG_NO /* 시험관리번호 */
						        ,B.TEAM_GBN /* 시험구분 */
						        ,B.EXAM_TITLE /* 시험제목 */
						        ,TO_CHAR(TO_DATE(B.APP_PERIOD_FROM, 'YYYYMMDD'), 'YYYY-MM-DD') || ' ~ ' || TO_CHAR(TO_DATE(B.APP_PERIOD_TO, 'YYYYMMDD'), 'YYYY-MM-DD') AS APP_PERIOD /* 신청기간 */
						        ,TO_CHAR(TO_DATE(B.EXAM_PERIOD_FROM, 'YYYYMMDD'), 'YYYY-MM-DD') || ' ~ ' || TO_CHAR(TO_DATE(B.EXAM_PERIOD_TO, 'YYYYMMDD'), 'YYYY-MM-DD') AS EXAM_PERIOD /* 시험기간 */
						        ,B.EXAM_WAY_CD /* 시험방식코드 */
						        ,CASE 
						        		B.EXAM_WAY_CD WHEN '01' THEN
							            CASE 
							            		B.VISIT_AREA_CD WHEN '01' THEN '방문(서울)'
							            		ELSE '방문(용인)' 
					            		END
							       		ELSE '온라인'
							    END AS EXAM_WAY /* 시험방식 */
							    ,CASE 
							    		WHEN B.RECRUIT_WAY_CD = '01' THEN '선착순'
							            ELSE '신청기간종료시까지'
							    END AS RECRUIT_WAY
						        ,CASE 
						        		WHEN A.PANEL_SEL_YN = 'Y' THEN 'selection' /* 패널선정 */
						            	WHEN A.EXAM_APP_YN = 'Y' THEN 'applying' /* 진행중 */
						            	WHEN B.STATE_CD = '01' THEN 'standby' /* 신청대기 */
						            	ELSE 'available' /* 신청가능 */
						        END AS STATUS /* 상태 */
						FROM 
						 		RDEI102DT A 
						 		INNER JOIN RDEI101MT B ON A.EXAM_MNG_NO = B.EXAM_MNG_NO
				        WHERE 
						        A.USER_ID = #USER_ID#  /* 패널ID */ 
				  	 			AND A.MSG_TRAN_YN = 'Y' /* 공고전송 */
				   				AND B.EXAM_PERIOD_TO >= TO_CHAR(SYSDATE, 'YYYYMMDD') /* 시험일자 종료시까지 */
							    <include refid="testAnnounceWhere"/>
						ORDER BY
						 		B.APP_PERIOD_TO ASC
			 			)
			 			S1
				)
				S2
		WHERE
            	S2.RNUM BETWEEN #firstRecordIdx# AND #lastRecordIdx#
    </select>
    
    
    <!-- 시험모집 상세정보 -->
   	<resultMap id="getTestAnnounceView" class="HashMap">
			<result property="EXAM_MNG_NO" column="EXAM_MNG_NO" />
			<result property="EXAM_TITLE" column="EXAM_TITLE" />
			<result property="STATUS" column="STATUS" />
			<result property="MNG_CD" column="MNG_CD" />
			<result property="TEAM_GBN" column="TEAM_GBN" />
			<result property="DUP_APP" column="DUP_APP" />
			<result property="EXAM_APP_YN" column="EXAM_APP_YN" />
			<result property="EXAM_APP_YN2" column="EXAM_APP_YN2" />
			<result property="EXAM_WAY_CD" column="EXAM_WAY_CD" />
			<result property="VISIT_PLACE" column="VISIT_PLACE" />
			<result property="EXAM_WAY" column="EXAM_WAY" />
			<result property="RECRUIT_WAY" column="RECRUIT_WAY" />
			<result property="APP_PERIOD" column="APP_PERIOD" />
			<result property="EXAM_PERIOD" column="EXAM_PERIOD" />
			<result property="EXAM_OUTLINE" column="EXAM_OUTLINE" jdbcType="CLOB" javaType="java.lang.String" />
			<result property="APP_CANCEL_YN" column="APP_CANCEL_YN" />
	</resultMap>
    <select id="selectTestAnnounceView" parameterClass="HashMap" resultMap="getTestAnnounceView">
        /* TestAnnounce.selectTestAnnounceView */
		SELECT
				A.EXAM_MNG_NO
		        ,A.EXAM_TITLE
		        ,CASE 
		        		WHEN B.PANEL_SEL_YN = 'Y' THEN 'selection' /* 패널선정 */
		            	WHEN B.EXAM_APP_YN = 'Y' THEN 'applying' /* 신청중 */
		            	WHEN A.STATE_CD = '01' THEN 'standby' /* 신청대기 */
		            	ELSE 'available' /* 신청가능 */
		        END AS STATUS /* 상태 */
		        ,A.MNG_CD
		        ,A.TEAM_GBN
		        ,CASE A.DUP_APP_CD 
		        		WHEN '01' THEN '불가'
		                WHEN '02' THEN '가능'
		        END AS DUP_APP
                ,CASE B.EXAM_APP_YN WHEN 'Y' THEN 'Y'
		            	ELSE 'N'
		        END AS EXAM_APP_YN
		        ,CASE A.STATE_CD WHEN '02' THEN 'Y' ELSE 'N' END AS EXAM_APP_YN2
		        ,A.EXAM_WAY_CD
		        ,A.VISIT_PLACE
       			,CASE A.EXAM_WAY_CD
       					WHEN '01' THEN
					            CASE A.VISIT_AREA_CD 
					            		WHEN '01' THEN '방문(서울)'
					            		ELSE '방문(용인)' 
			            		END
			       		ELSE '온라인'
			    END AS EXAM_WAY /* 시험방식 */
			    ,CASE 
			    		WHEN A.RECRUIT_WAY_CD = '01' THEN '선착순'
			            ELSE '신청기간종료시까지'
			    END AS RECRUIT_WAY
		        ,TO_CHAR(TO_DATE(A.APP_PERIOD_FROM || A.APP_START_TIME || '00', 'YYYYMMDD HH24MISS'), 'YYYY-MM-DD HH24:MI') || ' ~ ' || TO_CHAR(TO_DATE(A.APP_PERIOD_TO || A.APP_END_TIME || '00', 'YYYYMMDD HH24MISS'), 'YYYY-MM-DD HH24:MI') AS APP_PERIOD /* 신청기간 */
		        ,TO_CHAR(TO_DATE(A.EXAM_PERIOD_FROM, 'YYYYMMDD'), 'YYYY-MM-DD') || ' ~ ' || TO_CHAR(TO_DATE(A.EXAM_PERIOD_TO, 'YYYYMMDD'), 'YYYY-MM-DD') AS EXAM_PERIOD /* 시험기간 */
		        ,A.EXAM_OUTLINE
      			,CASE B.EXAM_APP_YN WHEN 'Y' THEN
      			     CASE 
                    	 WHEN SYSDATE - TO_DATE(A.APP_PERIOD_TO || A.APP_END_TIME || '00', 'YYYYMMDD HH24MISS') <![CDATA[<]]> 0 AND SYSDATE - TO_DATE(A.EXAM_PERIOD_TO, 'YYYYMMDD') <![CDATA[<]]> 0  THEN 'Y'
                    	 ELSE 'N'
                     END
                     ELSE 'N' 
                END AS APP_CANCEL_YN
		FROM 
				RDEI101MT A
				INNER JOIN RDEI102DT B ON A.EXAM_MNG_NO = B.EXAM_MNG_NO
		WHERE 	
				B.USER_ID = #USER_ID#
				AND A.EXAM_MNG_NO = #EXAM_MNG_NO#
    </select>
    
    
    <!-- 시험모집공고 상세 보기 > 방문 목록 -->
    <select id="selectTestAnnounceVisitList" parameterClass="HashMap" resultClass="HashMap">
    	/* TestAnnounce.selectTestAnnounceVisitList */
    	SELECT
	    		A.EXAM_ORDER
	      		,TO_CHAR(TO_DATE(A.VISIT_DATE, 'YYYYMMDD'), 'YYYY-MM-DD ') || SUBSTR(VISIT_TIME_FROM, 1, 2) || ':' || SUBSTR(VISIT_TIME_FROM, 3, 2) || ' ~ ' || SUBSTR(VISIT_TIME_TO, 1, 2) || ':' || SUBSTR(VISIT_TIME_TO, 3, 2) AS VISIT
	    FROM 
	    		RDEI103DT A
	    		INNER JOIN RDEI102DT B ON A.EXAM_MNG_NO = B.EXAM_MNG_NO
	 	WHERE 
	 			B.USER_ID = #USER_ID#
	 			AND A.EXAM_MNG_NO = #EXAM_MNG_NO#
    </select>
    
    
    <!-- 시험모집공고 상세 보기 > 온라인 설문 -->
    <select id="selectTestAnnounceOnlineList" parameterClass="HashMap" resultClass="HashMap">
    	/* TestAnnounce.selectTestAnnounceOnlineList */
		SELECT
		        CASE SURVEY_GBN 
		        		WHEN '01' THEN TO_CHAR(TO_DATE(A.SURVEY_PERIOD_FROM, 'YYYYMMDD'), 'YYYY-MM-DD') || ' ~ ' || TO_CHAR(TO_DATE(A.SURVEY_PERIOD_TO, 'YYYYMMDD'), 'YYYY-MM-DD')
		                WHEN '02' THEN TO_CHAR(TO_DATE(A.SURVEY_PREPARE_DATE, 'YYYYMMDD'), 'YYYY-MM-DD')
		        END AS SURVEY_PERIOD
		FROM 
				RDEI104DT A
				INNER JOIN RDEI102DT B ON A.EXAM_MNG_NO = B.EXAM_MNG_NO
		WHERE 
				B.USER_ID = #USER_ID#
				AND A.EXAM_MNG_NO = #EXAM_MNG_NO#
		ORDER BY 
				SEQ
    </select>

    
    <!-- 시험 참가/취소 신청 -->
    <update id="updateTestAnnounce" parameterClass="HashMap">
        /* TestAnnounce.updateTestAnnounce */
        UPDATE
            RDEI102DT
        SET
            EXAM_APP_YN = #EXAM_APP_YN#
            ,EXAM_APP_DATE = SYSDATE
        WHERE
            USER_ID = #USER_ID#
            AND EXAM_MNG_NO = #EXAM_MNG_NO#
    </update>
    
    
    <!-- 고객 정보 수정 -->
    <update id="updateMyInfo" parameterClass="HashMap">
        /* TestAnnounce.updateMyInfo */
        UPDATE
            	RDUR102DT 
        SET
           		PHONE = #PHONE#
        WHERE
            	USER_ID = #USER_ID#
    </update>
    
    
    <!-- 설문조사 삭제 -->
    <delete id="deleteSurveyResearchDelete" parameterClass="HashMap">
        /* TestAnnounce.deleteSurveyResearchDelete */
        DELETE FROM 
        	RDSR201DT 
        WHERE
            USER_ID = #USER_ID#
            AND EXAM_MNG_NO = #EXAM_MNG_NO#
    </delete>
    
    
    <!-- 상세설문 동의서 -->
    <resultMap id="getDetailAgreeHtml" class="HashMap">
			<result property="ENTRY_APP_AGREE_CONTENT" column="ENTRY_APP_AGREE_CONTENT" jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>
    <select id="selectDetailAgreeHtml" parameterClass="HashMap" resultMap="getDetailAgreeHtml">
    	/* TestAnnounce.selectDetailAgreeHtml */
		SELECT
		        ENTRY_APP_AGREE_CONTENT
		FROM 
				RDEI101MT
		WHERE 
				EXAM_MNG_NO = #EXAM_MNG_NO#
    </select>
    
    
	<!-- 참가신청 전 시험신청 가능 여부 확인 -->
    <select id="selectAppAvailableYn" parameterClass="HashMap" resultClass="HashMap">
    	/* TestAnnounce.selectAppAvailableYn */
	    SELECT
	   			CASE A.STATE_CD WHEN '02' THEN 'Y'
	                                      ELSE 'N'
	       		END AS APP_YN
	    FROM 
	    		RDEI101MT A
		WHERE 
				A.EXAM_MNG_NO = #EXAM_MNG_NO#
    </select>
    
</sqlMap>
