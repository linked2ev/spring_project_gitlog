package com.rdpanel.fo.com.controller;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Map;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

import com.rdpanel.fo.com.service.CommonService;
import com.rdpanel.fo.mp.service.MyPageService;
import com.webiz.util.StringUtil;

/**
* <pre>
* 1. 패키지명 : com.rdpanel.fo.com
* 2. 타입명 : CommonController.java
* 3. 작성일 : 2017. 11. 20.
* 4. 작성자 : JAMUGE
* 5. 설명 : CommonController
* </pre>
 */
@Controller
public class CommonController {

	static final Logger logger = LoggerFactory.getLogger(CommonController.class);

    @Resource(name="commonService") 
    private CommonService commonService;   
    
    @Resource(name="myPageService") 
    private MyPageService myPageService; 
    
    

    @RequestMapping("/fo/com/fileUpload.do")
   	public ModelAndView fileUpload(HttpServletRequest request, @RequestParam Map<String, Object> commandMap) throws Exception {
    	
   		ModelAndView mv = new ModelAndView("jsonView");
   		
		
		//result = this.commonService.deleteSurveyResult(request ,commandMap);
		 

		return mv;
   	}
    
    
    /**
    * <pre>
    * 1. 메소드명 : receiveUnsubscribe
    * 2. 작성일 : 2017. 11. 27.
    * 3. 작성자 : JAMUGE
    * 4. 설명 : [CJ] 080수신거부 연동 인터페이스 서비스에서 수신거부 정보를 받고 응답정보를 리턴한다.
    * </pre>
    * @param request
    * @param commandMap
    * @return
    * @throws Exception
     */
    @RequestMapping(value="/fo/com/receiveUnsubscribe.do", method = RequestMethod.POST)
    public ModelAndView receiveUnsubscribe(HttpServletRequest request, @RequestParam Map<String, Object> commandMap) throws Exception 
    {
    	ModelAndView mv = new ModelAndView();
    	
      	logger.info("\n ===============================================================================");
    	logger.info("\n =========================== 080 수신거부 처리 시작 ============================\n\n\n");
    	logger.info("\n >> refererUrl  : " + StringUtil.getString(request.getHeader("referer"), ""));
    	logger.info("\n >> T_ID        : " + StringUtil.getString(commandMap.get("T_ID"), ""));
    	logger.info("\n >> T_TIME      : " + StringUtil.getString(commandMap.get("T_TIME"), ""));
    	logger.info("\n >> MENU_NAME   : " + StringUtil.getString(commandMap.get("MENU_NAME"), ""));
    	logger.info("\n >> ANI         : " + StringUtil.getString(commandMap.get("ANI"), ""));
    	logger.info("\n >> DTMF_CNT    : " + StringUtil.getString(commandMap.get("DTMF_CNT"), ""));
    	logger.info("\n >> DTMF_1      : " + StringUtil.getString(commandMap.get("DTMF_1"), ""));
    	
    	String ment = "F_FAIL";
    	
    	/**
    	 * DTMF_1 에 값이 있는 경우, DTMF_1 의 값을 수신거부 전화번호로 사용한다.
         * DTMF_1 에 값이 없는 경우, ANI 의 값을 수신거부 전화번호로 사용한다.
    	 */
    	String phone = StringUtil.getString(commandMap.get("DTMF_1"), StringUtil.getString(commandMap.get("ANI"), "")); 
    	if(!"".equals(phone))
    	{
    		commandMap.put("PHONE", phone);
    		
    		int cnt = this.commonService.selectUnsubscribePanelInfoCnt(request, commandMap);
    		logger.info("\n >> 회원 cnt   : " + cnt);
    		
    		if(cnt > 0)
    		{
    			cnt = this.commonService.updateUnsubscribePanelInfo(request, commandMap);
    			
    			if(cnt > 0)
    			{
    				ment = "F_succ";
    			}
    		}
    	}	
    
    	// 리턴 할 데이터
    	Date d = new Date();
        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMddHHmmss");
        
        commandMap.put("T_ID", commandMap.get("T_ID"));           // 받은 값을 응답시 그대로 돌려준다
		commandMap.put("MENU_NAME", commandMap.get("MENU_NAME")); // 받은 값을 응답시 그대로 돌려준다
		commandMap.put("T_TIME", sdf.format(d));                  // 응답 전문 전송 시간
		commandMap.put("RESULT", "0");       // 0: 성공
		commandMap.put("ACTION_TYPE", "3");  // 고정값
		commandMap.put("NEXT_MENU", "");     // 고정값
		commandMap.put("MENT_FLAG", "0");    // 고정값
		commandMap.put("MENT_CNT", "1");     // 고정값
		commandMap.put("MENT_1", ment);      // 성공 유무
		mv.addObject("commandMap", commandMap);
		
      	logger.info("\n ===============================================================================");
    	logger.info("\n =========================== 080 수신거부 처리 종료 ============================\n\n\n");
    	
    	return mv;
    }
}
