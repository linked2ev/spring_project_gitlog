package com.rdpanel.cmmn.interceptor;

import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;

import com.rdpanel.cmmn.security.SessionsPanel;

/**
* <pre>
* 1. 패키지명 : com.rdpanel.cmmn.interceptor
* 2. 타입명 : SecurityInterceptor.java
* 3. 작성일 : 2017. 11. 28.
* 4. 작성자 : JAMUGE
* 5. 설명 : Web Access Security Interceptor
* </pre>
 */
public class SecurityInterceptor extends HandlerInterceptorAdapter {

	static final Logger logger = LoggerFactory.getLogger(SecurityInterceptor.class);
	
	@Value("#{config['webRootDomain']}")
  	String webRootDomain;
	
	@Value("#{config['admRootDomain']}")
	String admRootDomain;
	
	@Value("#{config['file.webRootPath']}")
  	String webRootPath;
	
	@Value("#{config['file.uploadPath']}")
	String uploadPath;
	
	@Value("#{config['amoreAdminNum']}")
	String amoreAdminNum;
	
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception
    {
    	logger.info("\n ===============================================================================");
    	logger.info("\n =============== SecurityInterceptor :: frontOffice (패널) 시작 ================");

    	boolean result = false;
        
        String uri = request.getRequestURI().toString().trim();
        
        try 
        {
        	/**
        	 * frontOffice (패널)
        	 */
        	if(uri.indexOf("/fo/") > -1)
        	{
        		/**
        		 * 공통 제외 URL
        		 */
                if(excludeUrl(request))
                {
                    result = true;
                }
                else
                {
                    /**
                     * 패널 세션 NULL 확인
                     */
                    if(SessionsPanel.isLogin(request))
                    {
                    	Map<String, Object> sessionPanelInfo = SessionsPanel.getSessionMap(request, "__SESSION_PANEL_INFO__");
                    	logger.info("\n >> login Success [sessionPanelInfo] : " + sessionPanelInfo);
                    	
                		// Attribute 저장
                		request.setAttribute("SESSION_PANEL_INFO", sessionPanelInfo);
                		request.setAttribute("SESSION_NAME", sessionPanelInfo.get("SESSION_NAME"));
                		request.setAttribute("REQUEST_URI", uri);
                		
            			// 패널 권한
            			request.setAttribute("panelAuth", sessionPanelInfo.get("SESSION_PANEL_AUTH")); 
        				result = true;
                    }
                    else
                    {
                        /**
                         * 패널 회원가입 시
                         */
                    	System.out.println("회원가입 시 : " + (uri.indexOf("/fo/mj/memberJoin") > -1) );
                        if (uri.indexOf("/fo/mj/memberJoin") > -1)
                        {
                        	System.out.println(">> chk");
                        	if(SessionsPanel.isJoinMem(request))
                        	{
                        		Map<String, Object> sessionJoinInfo = SessionsPanel.getSessionMap(request, "__SESSION_JOIN_MEM__");
                        		logger.info("\n >> memberJoin Access [sessionJoinInfo] : " + sessionJoinInfo);
                        		
                        		// Attribute 저장
                        		request.setAttribute("SESSION_NAME", sessionJoinInfo.get("SESSION_NAME"));
                        		request.setAttribute("panelAuth", "01");
                        		result = true;
                        	}
                        }
                        else
                        {
                        	if(isAjaxRequest(request))
                            {
                                result = true;
                            }
                            else
                            { 
                            	/**
                            	 * 비로그인 시 해당 링크로 접근할 시(시험 상세)
                            	 */
                            	if(uri.indexOf("/fo/ta/testAnnounceView") > -1)
                            	{
                            		String param = "?EXAM_MNG_NO=" + request.getParameter("EXAM_MNG_NO");
                            		request.setAttribute("loginReturnUrl", uri + param);
                            		
                                    result = true;
                            	}
                            	/**
                            	 * 비로그인 시 해당 링크로 접근할 시(시험 시험별 Q&A)
                            	 */
                            	else if(uri.indexOf("/fo/mp/qnaBoardList") > -1)
                            	{
                            		String param = "?EXAM_MNG_NO=" + request.getParameter("EXAM_MNG_NO");
                            		request.setAttribute("loginReturnUrl", uri + param);
                            		
                            		result = true;
                            	}
                            	else
                            	{
                            		response.sendRedirect(webRootDomain + "/fo/sc/login.do");  
                            		result = false;
                            	}
                            }	
                        }
                    }
                }
        	}
        	else
        	{
        		response.sendRedirect(webRootDomain + "/error.jsp");
        		result = true;
        	}
        } 
        catch (Exception e) 
        {
        	logger.error("/n #################### SecurityInterceptor :: Exception ####################");
            //e.printStackTrace();
            //logger.error(e.getMessage());
            logger.error("/n #################### SecurityInterceptor :: Exception ####################");
            return false;
        }
        
        /* *** config *** */
        request.setAttribute("webRootDomain", webRootDomain);
        request.setAttribute("admRootDomain", admRootDomain);
        request.setAttribute("webRootPath", webRootPath);
        request.setAttribute("uploadPath", uploadPath);
        request.setAttribute("amoreAdminNum", amoreAdminNum);
        request.setAttribute("LOCALE_LANG", "ko");
        request.setAttribute("LOCALE_JSP", uri.substring(uri.lastIndexOf("/")+1, uri.indexOf(".do")));

        logger.info("\n=============== SecurityInterceptor :: 종료 ===============");
        logger.info("\n >> [SecurityIntercepter] 종료 " + result);
          
        return result;
    }
    
    private boolean excludeUrl(HttpServletRequest request) {
    	
    	boolean result = false;
    	
        String uri = request.getRequestURI().toString().trim();
        
        if (uri.indexOf("/login.do") > -1 || uri.indexOf("Proc") > -1 || uri.indexOf("/logout.do") > -1 || uri.indexOf("/receiveUnsubscribe.do") > -1)
        {
        	result = true;
        }
        else 
        {
        	result = false;
        }
        
        return result;
    }
    
    private boolean isAjaxRequest(HttpServletRequest request) 
    {
        String requestedWithHeader = request.getHeader("X-Requested-With");
        return "XMLHttpRequest".equals(requestedWithHeader);
    }
    
}
