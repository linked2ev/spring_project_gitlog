<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="PanelSecurity">
	
    
    <!-- KCTR01MT_RND_PANEL 테이블에서 패널 상세정보 -->
    <select id="selectGetMstPanelInfo" parameterClass="com.rdpanel.cmmn.security.Panel" resultClass="HashMap">
    	/* PanelSecurity.selectGetMstPanelInfo */
		SELECT
		       CSTMID
		      ,CSTMNM
		      ,MOBILENO1
		      ,MOBILENO2
		      ,MOBILENO3
		      ,EMAIL1
		      ,EMAIL2
		      ,BRTHDATE
		      ,SUBSTR(BRTHDATE, 1, 4) AS YEAR
		      ,CASE SUBSTR(BRTHDATE, 5, 2) WHEN '00' THEN '01' ELSE SUBSTR(BRTHDATE, 5, 2) END AS MONTH
		      ,CASE SUBSTR(BRTHDATE, 7, 2) WHEN '00' THEN '01' ELSE SUBSTR(BRTHDATE, 7, 2) END AS DAY
		      ,CASE SUBSTR(BRTHDATE, 5, 4) WHEN '0000' THEN FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(BRTHDATE, 1, 4) || '0101', 'YYYYMMDD')) / 12)
		            ELSE FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(BRTHDATE, 'YYYYMMDD')) / 12)
		       END AS AGE
		      ,CASE WHEN (CASE SUBSTR(BRTHDATE, 5, 4) WHEN '0000' THEN FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(BRTHDATE, 1, 4) || '0101', 'YYYYMMDD')) / 12)
		            ELSE FLOOR(MONTHS_BETWEEN(SYSDATE, TO_DATE(BRTHDATE, 'YYYYMMDD')) / 12) END) >= 19 THEN 'Y'
		            ELSE 'N'
		       END AS AGE_YN
		      ,UCSTMID
		      ,SECPSWDFLAG
		      ,DORMANCYYN
		 FROM 
		      WEBDBA.KCTR01MT_RND_PANEL
		 WHERE 
		      CSTMID = #CSTMID#
    </select>
    
    
    <!-- KCTR01MT_RND_PANEL 테이블에서 패널 정보 조회 -->
    <select id="selectGetMstPanelCnt" parameterClass="com.rdpanel.cmmn.security.Panel" resultClass="Integer">
    	/* PanelSecurity.selectGetMstPanelCnt */
        SELECT
        		COUNT(*)
       	FROM 
       			WEBDBA.KCTR01MT_RND_PANEL
		WHERE
				CSTMID = #CSTMID# AND
			    <isEqual property="SECPSWDFLAG" compareValue="Y"> 
			    SECPSWD2 = #SECPSWD2#
				</isEqual>
				<isNotEqual property="SECPSWDFLAG" compareValue="Y"> 
				SECPSWD1 = #SECPSWD1#
				</isNotEqual>
    </select>


    <!-- 관리자 접속 IP 등록 -->
    <insert id="insertClientIp" parameterClass="com.rdpanel.cmmn.security.Panel">
    	/* PanelSecurity.insertClientIp */
    	INSERT INTO
    		RDCH101HT
    		(
    			ACCESS_MNG_NO
				,USER_ID
				,ACCESS_IP
				,ACCESS_DATE
   			)
   		VALUES
   			(
   				RDCH101HT_SEQ.NEXTVAL
   				,#USER_ID#
   				,#IP#
   				,SYSDATE
   			)
    </insert>
    
    
</sqlMap>
